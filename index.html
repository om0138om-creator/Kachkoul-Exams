<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>
        // Ø¶Ø¹ Ù‡Ù†Ø§ Ø§Ù„Ø¢ÙŠ Ø¯ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙˆØ¨Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†
        const DEBUG_OWNERS = [5845118527, 1852302587, 8380781408];
        
        // ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('load', function() {
            // 1. ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ† (Eruda)
            try {
                const user = window.Telegram.WebApp.initDataUnsafe?.user;
                // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù…Ù„Ø§Ùƒ
                if (user && DEBUG_OWNERS.includes(user.id)) {
                    eruda.init();
                    console.log("ğŸ‘¨â€ğŸ’» Developer Mode Active");
                }
            } catch (e) {}

            // 2. âš¡ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø®Ø· Ø§Ù„Ø¹Ø§Ù… Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
            try {
                // Ù†ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Firebase Ø¬Ø§Ù‡Ø²Ø§Ù‹ (db Ù…Ø¹Ø±Ù ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„)
                if (typeof db !== 'undefined') {
                    console.log("ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø®Ø· Ù…Ø®ØµØµ Ù„Ù„Ù…Ù†ØµØ©...");
                    db.collection('settings').doc('global_config').get().then((doc) => {
                        if (doc.exists && doc.data().customFont) {
                            console.log("âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø®Ø· Ø¹Ø§Ù…! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...");
                            applyCustomFont(doc.data().customFont);
                        } else {
                            console.log("â„¹ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø®Ø· Ù…Ø®ØµØµØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ.");
                        }
                    }).catch((error) => {
                        // Ù„Ø§ Ù†Ø²Ø¹Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø®Ø·Ø£ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¬Ø±Ø¯ Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„
                        console.log("Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø· (Ø±Ø¨Ù…Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ù†ØªØ±Ù†Øª):", error);
                    });
                }
            } catch (e) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø®Ø·ÙˆØ·:", e);
            }
        });
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
        :root {
            --primary-gradient: linear-gradient(45deg, #FF512F, #DD2476); /* Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
            --bg-main: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); /* Ø®Ù„ÙÙŠØ© Ù†Ù‡Ø§Ø±ÙŠØ© ÙØ§ØªØ­Ø© */
            --card-bg: #ffffff; /* Ù„ÙˆÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ø¨ÙŠØ¶ */
            --text-main: #2c3e50; /* Ø§Ù„Ù†Øµ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„Ø¯Ø§ÙƒÙ† */
            --text-sub: #6c757d; /* Ø§Ù„Ù†Øµ Ø§Ù„ÙØ±Ø¹ÙŠ */
            --input-bg: #f8f9fa; /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ */
            --border-color: #eee; /* Ù„ÙˆÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯ */
            --shadow-color: rgba(0,0,0,0.1); /* Ù„ÙˆÙ† Ø§Ù„Ø¸Ù„ */
            --accent-glow: transparent; /* Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆÙ‡Ø¬ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø± */
        }

        /* ğŸ”¥ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ ğŸ”¥ */
        body.night-mode {
            /* Ø®Ù„ÙÙŠØ© Ø¹Ù…ÙŠÙ‚Ø© Ø¯Ø§ÙƒÙ†Ø© Ø¬Ø¯Ø§Ù‹ */
            --bg-main: linear-gradient(to bottom, #0f0c29, #302b63, #24243e);
            /* Ù„ÙˆÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙŠØªØ­ÙˆÙ„ Ù„Ø±Ù…Ø§Ø¯ÙŠ Ù…Ø²Ø±Ù‚ Ø¯Ø§ÙƒÙ† Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£Ø¨ÙŠØ¶ */
            --card-bg: #1a1a2e;
            /* Ø§Ù„Ù†ØµÙˆØµ ØªØµØ¨Ø­ ÙØ§ØªØ­Ø© */
            --text-main: #e6e6e6;
            --text-sub: #a0a0a0;
            /* Ø§Ù„Ø­Ù‚ÙˆÙ„ ØªØµØ¨Ø­ Ø¯Ø§ÙƒÙ†Ø© Ù„ØªØ±ÙŠØ­ Ø§Ù„Ø¹ÙŠÙ† */
            --input-bg: #2a2a4e;
            --border-color: #444;
            /* Ø¸Ù„ Ø£Ø¹Ù…Ù‚ */
            --shadow-color: rgba(0,0,0,0.5);
            /* Ø¥Ø¶Ø§ÙØ© Ù„ÙˆÙ† ØªÙˆÙ‡Ø¬ Ø®ÙÙŠÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ: ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡ Ù„Ø£Ø­Ù…Ø± Ø£Ùˆ Ø£Ø²Ø±Ù‚) */
            --accent-glow: 0 0 15px rgba(102, 126, 234, 0.2);
        }

        body {
            font-family: inherit;
            background: var(--bg-main); /* Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
            min-height: 100vh;
            padding: 15px;
            padding-top: 80px;
            direction: rtl;
            color: var(--text-main); /* ØªÙˆØ­ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ù†Øµ */
            transition: all 0.5s cubic-bezier(0.4, 0.0, 0.2, 1); /* Ø£Ù†Ù…ÙŠØ´Ù† ØªØ­ÙˆÙ„ Ø³Ù„Ø³ Ø¬Ø¯Ø§Ù‹ */
        }

        /* ØªØ­Ø¯ÙŠØ« ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù„ÙŠØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
        .card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px var(--shadow-color);
            text-align: center;
            margin-bottom: 20px;
            /* Ø¥Ø¶Ø§ÙØ© Ø­Ø¯ÙˆØ¯ Ø®ÙÙŠÙØ© ÙˆØªÙˆÙ‡Ø¬ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        /* ØªØ£Ø«ÙŠØ± Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
        body.night-mode .card {
            box-shadow: var(--accent-glow); /* Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆÙ‡Ø¬ */
        }

        /* ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ (Inputs) Ù„ØªØµØ¨Ø­ Ø¯Ø§ÙƒÙ†Ø© ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
        .admin-input, select, .opt-text, .opt-expl {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-family: inherit;
            /* Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
            background: var(--input-bg) !important;
            color: var(--text-main) !important;
            transition: 0.3s;
        }
        /* ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ */
        .admin-input:focus, select:focus {
            border-color: #FF512F;
            box-shadow: 0 0 8px rgba(255, 81, 47, 0.3);
        }

        /* ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø§Ù„Ù‡ÙŠØ¯Ø± ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
        .app-header {
            background: var(--card-bg); /* Ø³ÙŠØµØ¨Ø­ Ø¯Ø§ÙƒÙ†Ø§Ù‹ ÙÙŠ Ø§Ù„Ù„ÙŠÙ„ */
            /* ... Ø¨Ø§Ù‚ÙŠ ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù‡ÙŠØ¯Ø± ÙƒÙ…Ø§ Ù‡ÙŠ ... */
        }


        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hidden { display: none !important; }

        /* Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
        h1 {
            color: var(--dark);
            font-size: 24px;
            margin-bottom: 10px;
        }

        h2 {
            color: var(--dark);
            font-size: 20px;
            margin-bottom: 15px;
        }

        .subtitle {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 20px;
        }

        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙƒØ¨ÙŠØ±Ø© */
        .big-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± */
        .exam-info {
            background: var(--light);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: right;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .info-row:last-child { border-bottom: none; }

        .info-label {
            color: var(--gray);
            font-size: 15px;
        }

        .info-value {
            color: var(--dark);
            font-weight: bold;
            font-size: 15px;
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn {
            display: inline-block;
            padding: 15px 35px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            margin: 8px;
        }

        .btn:active { transform: scale(0.95); }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ÙˆÙ‚Øª */
        .timer-container {
            background: white;
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .timer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .timer-display {
            font-size: 22px;
            font-weight: bold;
            color: var(--dark);
        }

        .timer-display.danger {
            color: var(--danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .question-counter {
            font-size: 14px;
            color: var(--gray);
            background: var(--light);
            padding: 5px 15px;
            border-radius: 20px;
        }

        .progress-track {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 4px;
            transition: width 0.4s ease;
        }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ */
        .question-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .question-number {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 8px 25px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 17px;
            color: var(--dark);
            line-height: 1.9;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            border-right: 5px solid var(--primary);
            margin-bottom: 25px;
            text-align: right;
            white-space: pre-wrap;
        }

        /* Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px 20px;
            background: var(--light);
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option:hover {
            border-color: var(--primary);
            background: #f0f3ff;
        }

        .option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1));
        }

        .option.correct {
            border-color: var(--success);
            background: rgba(39, 174, 96, 0.15);
        }

        .option.wrong {
            border-color: var(--danger);
            background: rgba(231, 76, 60, 0.15);
        }

        .option.locked { pointer-events: none; }

        .option-marker {
            width: 28px;
            height: 28px;
            border: 2px solid #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: #ccc;
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .option.selected .option-marker {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .option.correct .option-marker {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .option.wrong .option-marker {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        .option-text {
            flex: 1;
            font-size: 15px;
            color: var(--dark);
            text-align: right;
            line-height: 1.6;
        }

        /* Ø²Ø± Ø§Ù„ØªØ³Ù„ÙŠÙ… */
        .submit-container {
            margin-top: 25px;
        }

        .submit-btn {
            width: 100%;
            padding: 16px;
            font-size: 17px;
            font-weight: 600;
            border: none;
            border-radius: 15px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .submit-btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© */
        .result-icon {
            font-size: 90px;
            margin-bottom: 15px;
        }

        .result-score {
            font-size: 60px;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 15px 0;
        }

        .result-stats {
            background: var(--light);
            border-radius: 15px;
            padding: 20px;
            margin: 25px 0;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-row:last-child { border-bottom: none; }

        .stat-label { color: var(--gray); }

        .stat-value {
            font-weight: bold;
            color: var(--dark);
        }

        .stat-value.success { color: var(--success); }
        .stat-value.danger { color: var(--danger); }

        /* Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 25px 45px;
            border-radius: 20px;
            font-size: 22px;
            font-weight: bold;
            z-index: 9999;
            animation: toastIn 0.4s ease;
        }

        .toast.success { background: #d4edda; color: var(--success); }
        .toast.error { background: #f8d7da; color: var(--danger); }

        @keyframes toastIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        /* ØªÙ†Ø¨ÙŠÙ‡ */
        .alert {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            text-align: right;
            font-size: 14px;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 50px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e0e0e0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            color: var(--gray);
            font-size: 16px;
        }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ„ */
        .explanation-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s;
        }
        
        .explanation-content {
            background: white;
            width: 90%;
            max-width: 400px;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
        }

        .explanation-title {
            color: var(--danger);
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .explanation-text {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            color: var(--dark);
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 16px;
            border: 1px solid #eee;
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* ğŸ¨ ØªØµÙ…ÙŠÙ… Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--dark);
            margin: 20px 0 10px 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }

        /* ğŸ”˜ ØªØµÙ…ÙŠÙ… Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ (On/Off Switches) */
        .toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input { opacity: 0; width: 0; height: 0; }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(24px); }

        /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        .admin-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 15px;
            margin-bottom: 10px;
            transition: 0.3s;
            font-family: inherit;
        }

        .admin-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠØ± */
        .edit-card {
            background: #fff;
            border: 1px solid #eee;
            border-right: 4px solid var(--primary);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            animation: slideUp 0.3s ease;
        }

        .remove-q-btn {
            position: absolute;
            top: 10px; left: 10px;
            background: #ffebee;
            color: #c62828;
            border: none;
            width: 30px; height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ„ (Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹) */
        .explanation-field {
            display: none; /* Ù…Ø®ÙÙŠ */
            background: #e8f5e9;
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
        }
        
        .explanation-field.active { display: block; } /* ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ */

        .duration-field {
            display: none;
            margin-top: 10px;
        }
        .duration-field.active { display: block; }

        /* Ø²Ø± Ø¹Ø§Ø¦Ù… Ù„Ù„Ø¥Ø¶Ø§ÙØ© */
        .fab-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            font-size: 30px;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        
        .theme-toggle { font-size: 22px; cursor: pointer; transition: 0.3s; }
        /* ğŸš€ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¨Ø§Ø± Ù„Ù…Ø±Ø¨Ø¹ Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ */
        .stats-card-btn {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%); /* Ù„ÙˆÙ† Ù†Ù‡Ø§Ø± Ø­ÙŠÙˆÙŠ */
            color: white; 
            padding: 30px; 
            border-radius: 25px;
            margin-bottom: 25px; 
            cursor: pointer; 
            text-align: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            border: 3px solid rgba(255,255,255,0.3);
            position: relative; 
            overflow: hidden; /* Ø¶Ø±ÙˆØ±ÙŠ Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ù„Ù…Ø¹Ø§Ù† */
        }

        /* ğŸ’¥ Ø£Ù†Ù…ÙŠØ´Ù† Ø§Ù„Ø­Ø±ÙƒØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */
        .stats-card-btn:active {
            transform: scale(0.9) rotate(-2deg);
            filter: brightness(1.2);
        }

        /* âœ¨ ØªØ£Ø«ÙŠØ± Ø§Ù„Ù„Ù…Ø¹Ø§Ù† Ø§Ù„Ø³Ø­Ø±ÙŠ Ø§Ù„Ø°ÙŠ ÙŠÙ…Ø± ÙÙˆÙ‚ Ø§Ù„Ù…Ø±Ø¨Ø¹ */
        .stats-card-btn::after {
            content: ''; 
            position: absolute; 
            top: -50%; 
            left: -50%;
            width: 200%; 
            height: 200%; 
            background: rgba(255,255,255,0.2);
            transform: rotate(45deg); 
            transition: 0.6s;
        }
        .stats-card-btn:hover::after { 
            left: 120%; 
        }

        /* ğŸ”´ Ø´ÙƒÙ„ Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø§Ù„Ø¬Ø¨Ø§Ø± (Ø£Ø­Ù…Ø± Ù†ÙŠÙˆÙ†) */
        /* ğŸŒ‘ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø§Ù„Ø¬Ø¨Ø§Ø± Ø§Ù„Ù…Ø·ÙˆØ± (Ø¥ØµÙ„Ø§Ø­ ØªØ¨Ø§ÙŠÙ† Ø§Ù„Ù†ØµÙˆØµ) */
        body.night-mode {
            --bg: #050505;
            --card-bg: #121212;
            --text-main: #ffffff;
            --text-sub: #ff4d4d;
            --border-glow: 0 0 15px rgba(255, 0, 60, 0.4);
            --primary: #ff003c;
            --secondary: #990024;
            --input-bg: #1a1a1a;
        }

        /* ğŸš€ Ø¥Ø¬Ø¨Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ù†ØµÙˆØµ Ø¹Ù„Ù‰ Ø§Ù„ØªØºÙŠØ± ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
        body.night-mode .card, 
        body.night-mode .app-header, 
        body.night-mode .admin-input,
        body.night-mode select,
        body.night-mode textarea {
            background: var(--card-bg) !important;
            color: var(--text-main) !important;
            border-color: var(--primary) !important;
        }

        /* Ø¥ØµÙ„Ø§Ø­ Ù†ØµÙˆØµ Ø§Ù„Ø£Ø²Ø±Ø§Ø± (ÙƒØ§Ù†Øª ØªØ¸Ù‡Ø± Ø¨Ø§Ù„Ø£Ø³ÙˆØ¯) */
        body.night-mode .btn-outline,
        body.night-mode .info-label,
        body.night-mode .subtitle,
        body.night-mode h1, body.night-mode h2 {
            color: var(--text-main) !important;
        }

        /* Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨ÙˆØª (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø´ÙØ§ÙÙŠØ© ÙˆØ§Ù„Ù„ÙˆÙ†) */
        body.night-mode .btn-primary {
            background: linear-gradient(135deg, #ff003c, #000) !important;
            color: white !important;
            border: 1px solid white !important;
            box-shadow: 0 5px 15px rgba(255, 0, 60, 0.4);
        }

        /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
        body.night-mode .admin-input::placeholder {
            color: #666 !important;
        }

        /* ğŸ“Š Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„ÙƒØ¨ÙŠØ± Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (ØªÙ†Ø³ÙŠÙ‚ ÙÙŠÙÙŠØ¯ Ø£Ø­Ù…Ø±) */
        body.night-mode .stats-card-btn {
            background: linear-gradient(45deg, #ff003c, #000) !important;
            border: 3px solid #ff003c !important;
            box-shadow: 0 0 30px rgba(255, 0, 60, 0.6) !important;
        }

        
        /* === ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ù„Ø®Ø·ÙˆØ· (Ø¬Ø¯ÙŠØ¯) === */
        .app-header {
            position: fixed; top: 0; left: 0; right: 0;
            height: 60px; background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 1000;
        }
        .app-title { font-size: 18px; font-weight: bold; color: #667eea; }
        .menu-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #333; display: none; }
        
        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© */
        .dropdown-menu {
            position: fixed; top: 60px; left: 20px;
            background: white; border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            width: 200px; padding: 10px 0;
            display: none; z-index: 1001;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item {
            padding: 12px 20px; font-size: 15px; color: #333;
            cursor: pointer; display: flex; align-items: center; gap: 10px;
        }
        .dropdown-item:hover { background: #f8f9fa; }

        /* ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .dashboard-header { text-align: center; margin-bottom: 20px; }
        .action-card {
            background: #f8f9fa; border-radius: 12px; padding: 20px;
            text-align: center; cursor: pointer; border: 1px solid #eee;
            margin-bottom: 15px; transition: 0.2s;
        }
        .action-card:hover { border-color: #667eea; background: white; }
        #createExamForm { display: none; margin-top: 20px; } /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
        
        /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ù„Ø£Ù†Ù†Ø§ Ø£Ø¶ÙÙ†Ø§ Ù‡ÙŠØ¯Ø± */
        body { padding-top: 80px; }
        
    </style>
</head>
<body>

    <header class="app-header">
        <div class="menu-btn" onclick="toggleMenu()">â‹®</div>
        <div class="app-title">ÙƒØ´ÙƒÙˆÙ„ Ø§Ù„ÙÙˆØ§Ø¦Ø¯</div>
        <div class="theme-toggle" id="themeBtn" onclick="toggleNightMode()">ğŸŒ™</div>
    </header>


    <div class="dropdown-menu" id="dropdownMenu">
        <div class="dropdown-item" onclick="triggerFontUpload()"><span>ğŸ”¤</span> ØªØºÙŠÙŠØ± Ø®Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
        <div class="dropdown-item" onclick="resetFont()"><span>ğŸ”„</span> Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø®Ø· Ø§Ù„Ø£ØµÙ„ÙŠ</div>
        <div class="dropdown-item" onclick="location.reload()"><span>ğŸ”</span> ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©</div>
    </div>
    
    <input type="file" id="fontFileInput" accept=".ttf,.otf,.woff" style="display: none;" onchange="handleFontUpload(this)">

    <div class="container">
        
        <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
        <div class="card" id="loadingScreen">
            <div class="loading">
                <div class="spinner"></div>
                <div class="loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø± -->
        <div class="card hidden" id="noExamScreen">
            <div class="big-icon">ğŸ“š</div>
            <h1>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹</h1>
            <p class="subtitle">Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø®ØµØµ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙÙ‚Ø·</p>
            <div class="alert">
                â³ Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© ÙˆØ³ÙŠØªÙ… Ø¥Ø¹Ù„Ø§Ù…Ùƒ Ø¹Ù†Ø¯ ØªÙˆÙØ±Ù‡Ø§!
            </div>
            <button class="btn btn-primary" onclick="closeApp()">
                ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨ÙˆØª
            </button>
        </div>
        
        <div class="card hidden" id="statsScreen">
            <div style="font-size: 60px; margin-bottom:10px;">ğŸ“Š</div>
            <h1>Ø³Ø¬Ù„ÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</h1>
            <div class="exam-info">
                <div class="info-row"><span>âœ… Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©</span><span id="stTaken" class="info-value">0</span></div>
                <div class="info-row"><span>â³ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ©</span><span id="stPending" class="info-value">0</span></div>
                <div class="info-row"><span>ğŸ¯ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</span><span id="stAvg" class="info-value">0%</span></div>
            </div>
            <button class="btn btn-primary btn-block" onclick="showScreen('noExamScreen')">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        </div>
        

        <!-- Ø´Ø§Ø´Ø© ØªÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø³Ø¨Ù‚Ø§Ù‹ -->
        <div class="card hidden" id="alreadyTakenScreen">
            <div class="big-icon">ğŸ”’</div>
            <h1>ØªÙ… Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h1>
            <p class="subtitle">Ù„Ù‚Ø¯ Ø£Ø¬Ø±ÙŠØª Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø³Ø¨Ù‚Ø§Ù‹</p>
            <div class="exam-info">
                <div class="info-row">
                    <span class="info-label">Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</span>
                    <span class="info-value" id="prevScore">-</span>
                </div>
            </div>
            <div class="alert alert-danger">
                âš ï¸ Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø©!
            </div>
            <button class="btn btn-primary" onclick="closeApp()">
                ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨ÙˆØª
            </button>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
        <div class="card hidden" id="startScreen">
            <div class="big-icon">ğŸ“</div>
            <h1 id="examTitle">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h1>
            <p class="subtitle">Ø§Ø®ØªØ¨Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ø¢Ù†!</p>
            
            <div class="exam-info">
                <div class="info-row">
                    <span class="info-label">â“ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</span>
                    <span class="info-value" id="totalQuestions">0</span>
                </div>
                <div class="info-row">
                    <span class="info-label">â±ï¸ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</span>
                    <span class="info-value" id="examDuration">ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ğŸ“Š Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</span>
                    <span class="info-value">Ù…Ø­Ø§ÙˆÙ„Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·</span>
                </div>
            </div>

            <div class="alert">
                âš ï¸ <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ù„Ø¨Ø¯Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!
            </div>

            <button class="btn btn-success btn-block" onclick="startExam()">
                âœ… Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†
            </button>
            <button class="btn btn-outline" onclick="closeApp()">
                âŒ Ù„ÙŠØ³ Ø§Ù„Ø¢Ù†
            </button>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± -->
        <div id="examScreen" class="hidden">
            <div class="timer-container">
                <div class="timer-header">
                    <span class="timer-display" id="timerDisplay">â±ï¸ 00:00</span>
                    <span class="question-counter" id="questionCounter">1 / 10</span>
                </div>
                <div class="progress-track">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
            </div>

            <div class="question-card">
                <div class="question-number" id="questionBadge">Ø§Ù„Ø³Ø¤Ø§Ù„ 1</div>
                <div class="question-text" id="questionText">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§...</div>
                
                <div class="options-container" id="optionsContainer"></div>

                <div class="submit-container">
                    <button class="submit-btn" id="submitBtn" onclick="submitAnswer()" disabled>
                        ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© â¡ï¸
                    </button>
                </div>
            </div>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© -->
        <div class="card hidden" id="resultScreen">
            <div class="result-icon" id="resultIcon">ğŸ†</div>
            <h2 id="resultTitle">Ø£Ø­Ø³Ù†Øª!</h2>
            <div class="result-score" id="resultScore">85%</div>
            
            <div class="result-stats">
                <div class="stat-row">
                    <span class="stat-label">ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</span>
                    <span class="stat-value" id="statTotal">10</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">âœ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</span>
                    <span class="stat-value success" id="statCorrect">8</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">âŒ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©</span>
                    <span class="stat-value danger" id="statWrong">2</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">â±ï¸ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚</span>
                    <span class="stat-value" id="statTime">05:30</span>
                </div>
            </div>

            <p style="color: var(--success); margin-bottom: 20px;">
                âœ… ØªÙ… Ø­ÙØ¸ Ù†ØªÙŠØ¬ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!
            </p>

            <button class="btn btn-primary btn-block" onclick="closeApp()">
                ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨ÙˆØª
            </button>
        </div>

        <div id="explanationModal" class="explanation-modal hidden">
            <div class="explanation-content">
                <div class="explanation-title">âŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©</div>
                <div id="explanationText" class="explanation-text"></div>
                <button class="btn btn-primary btn-block" onclick="closeExplanation()">
                    Ø§Ù„ØªØ§Ù„ÙŠ â¬…ï¸
                </button>
            </div>
        </div>

        <div class="card hidden" id="adminPanel">
            <div class="dashboard-header">
                <h2>ğŸ‘‹ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
                <button class="btn btn-outline" onclick="location.reload()" style="padding: 5px 15px; font-size: 12px; margin-top:5px">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
            </div>

            <div class="action-card" onclick="toggleCreateForm()">
                <div style="font-size: 30px; margin-bottom: 5px;">â•</div>
                <div style="font-weight: bold;">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯</div>
            </div>

            <div id="createExamForm">
                <h3 style="margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
                
                <label>ğŸ“‚ Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…:</label>
                <select id="categorySelect" class="admin-input" style="background: #f8f9fa;">
                    <option value="" disabled selected>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…...</option>
                </select>
                
                <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</label>
                <input type="text" id="examTitleInput" class="admin-input" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¹Ù‚ÙŠØ¯Ø©">

            <div class="section-title">âš™ï¸ Ø§Ù„Ø®ØµØ§Ø¦Øµ</div>

            <div class="toggle-container">
                <span>â±ï¸ ØªØ­Ø¯ÙŠØ¯ ÙˆÙ‚Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±</span>
                <label class="switch">
                    <input type="checkbox" id="timerToggle" onchange="toggleDurationInput()">
                    <span class="slider"></span>
                </label>
            </div>
            <div id="durationInputContainer" class="duration-field">
                <input type="number" id="examDurationInput" class="admin-input" placeholder="Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ (Ù…Ø«Ø§Ù„: 30)">
            </div>

            <div class="toggle-container">
                <span>ğŸ’¡ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ„Ø§Øª (Ø´Ø±Ø­ Ø§Ù„Ø®Ø·Ø£)</span>
                <label class="switch">
                    <input type="checkbox" id="explanationToggle" onchange="toggleExplanationFields()">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="section-title">ğŸ“ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</div>
            
            <div id="questionsContainer">
                </div>

            <div style="height: 80px;"></div> <button class="fab-btn" onclick="addQuestionCard()">+</button>
            
            <button class="btn btn-success btn-block" onclick="saveExamToCloud()" style="position: fixed; bottom: 20px; right: 20px; width: calc(100% - 100px); z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                ğŸ’¾ Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ (Ø³Ø­Ø§Ø¨ÙŠ)
            </button>
        </div>
    </div> 

<script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // ==========================================
    // ğŸ›¡ï¸ ÙƒÙˆØ¯ Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡)
    // ==========================================
    
    // 1. Ù…Ø¤Ù‚Øª Ù„Ø¥Ø¬Ø¨Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø®ØªÙØ§Ø¡ Ø¨Ø¹Ø¯ 7 Ø«ÙˆØ§Ù†ÙŠ ÙÙŠ Ø­Ø§Ù„ Ø­Ø¯ÙˆØ« Ø®Ø·Ø£
    setTimeout(function() {
        const loadingScreen = document.getElementById('loadingScreen');
        if (loadingScreen && !loadingScreen.classList.contains('hidden')) {
            console.error("âš ï¸ Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (Timeout).");
            loadingScreen.classList.add('hidden');
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙˆØ§Ø¶Ø­Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            alert("âš ï¸ Ø§Ø³ØªØºØ±Ù‚ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆÙ‚ØªØ§Ù‹ Ø·ÙˆÙŠÙ„Ø§Ù‹.\nÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ ÙˆØ¬ÙˆØ¯ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Firebase.\n(Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØ±Ø³ Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø®Ø·Ø£)");
            
            // ØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ø´Ø§Ø´Ø© "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±" ÙƒØ¥Ø¬Ø±Ø§Ø¡ Ø§Ø­ØªÙŠØ§Ø·ÙŠ
            document.getElementById('noExamScreen').classList.remove('hidden');
        }
    }, 7000);

    // ==========================================
    // Ù†Ù‡Ø§ÙŠØ© ÙƒÙˆØ¯ Ø§Ù„Ø£Ù…Ø§Ù†
    // ==========================================
    
    const firebaseConfig = {
        apiKey: "AIzaSyCfFfo6mhQE702r476RWhvRP3Z86wGeu_o",
        authDomain: "kachkoul-exams.firebaseapp.com",
        projectId: "kachkoul-exams",
        storageBucket: "kachkoul-exams.firebasestorage.app",
        messagingSenderId: "583161070886",
        appId: "1:583161070886:web:16a0ca69b9c5c37bd4ede7",
        measurementId: "G-SZZNF25HHS"
    };

    // 2. ØªÙ‡ÙŠØ¦Ø© Firebase (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙˆØ¨Ø£Ù…Ø§Ù†)
    // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø±Ø· Ù„ÙŠÙƒÙˆÙ† Ù…ØªØ§Ø­Ø§Ù‹ Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
    let db = null; 

    try {
        if (typeof firebase !== 'undefined') {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            console.log("âœ… Firebase initialized successfully");
        } else {
            console.error("âŒ Ù…ÙƒØªØ¨Ø© Firebase Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ (ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª)");
            alert("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø§Øª Firebase. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
        }
    } catch (e) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:", e);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + e.message);
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //                    Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const BOT_TOKEN = "7592041395:AAEvcg8RPVmNgIbcrBYRZidpZx61q2Ftw-c";
    const CHANNEL_ID = "-1003308250289";
    const OWNERS = [5845118527, 1852302587, 8380781408];

    let tg = null;
    let examData = null;
    let currentQuestion = 0;
    let selectedOption = null;
    let userAnswers = [];
    let timerInterval = null;
    let timeRemaining = 0;
    let startTime = null;
    let finalResultToBot = null; // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©

    // ØªÙ‡ÙŠØ¦Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
    try {
        tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.MainButton.hide();
    } catch(e) {
        console.log('Not running in Telegram');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //                    ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        
        // 1. Ø¥Ø°Ø§ ÙˆØ¬Ø¯Ù†Ø§ ÙƒÙ„Ù…Ø© 'cats' ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· (Ø¬Ø§ÙŠ Ù…Ù† Ø§Ù„Ø¨ÙˆØª Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±)
        if (urlParams.has('cats')) {
            console.log("ğŸ› ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.");
            // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„ØªÙŠ ØªÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± + ØªØ­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
            if (typeof loadAndSyncCategories === 'function') {
                loadAndSyncCategories(); 
            } else {
                // Ø§Ø­ØªÙŠØ§Ø· ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ø§ ÙŠØ²Ø§Ù„ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                try { loadCategoriesFromURL(); } catch(e) {}
            }
        } 
        // 2. Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ (ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø£Ùˆ Ø¹Ø±Ø¶ Ø§Ø®ØªØ¨Ø§Ø±)
        else {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (Ù„ØªØ¹Ù…Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹)
            if (typeof fetchCategoriesFromCloud === 'function') {
                fetchCategoriesFromCloud();
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ø®ØªØ¨Ø§Ø±)
            setTimeout(loadExamData, 500);
        }
    });


    async function loadExamData() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const cloudId = urlParams.get('exam_id'); // Ù‡Ù„ ÙŠÙˆØ¬Ø¯ ID Ø³Ø­Ø§Ø¨ÙŠØŸ
            const legacyData = urlParams.get('data'); // Ù‡Ù„ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©ØŸ

            // 1. Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹ (Ù…Ù† Firebase)
            if (cloudId) {
                console.log("Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:", cloudId);
                const doc = await db.collection("exams").doc(cloudId).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    examData = {
                        id: cloudId,
                        user_id: window.Telegram.WebApp.initDataUnsafe?.user?.id || 0,
                        title: data.title,
                        duration: data.duration,
                        questions: data.questions.map((q, index) => ({
                            id: index + 1,
                            text: q.text,
                            options: q.options,
                            correct: q.correct,
                            explanations: q.explanations
                        }))
                    };
                    setupExamUI(); // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    return;
                } else {
                    alert("âš ï¸ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
                    showNoExamScreen();
                    return;
                }
            }

            // 2. Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ù„Ù„Ø§Ø­ØªÙŠØ§Ø·)
            if (legacyData) {
                const base64 = legacyData.replace(/-/g, '+').replace(/_/g, '/');
                const binaryString = window.atob(base64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const jsonString = pako.inflate(bytes, { to: 'string' });
                const rawData = JSON.parse(jsonString);

                examData = {
                    id: rawData.i || rawData.id,
                    user_id: rawData.u || rawData.user_id,
                    title: rawData.t || rawData.title,
                    duration: rawData.d || rawData.duration,
                    questions: (rawData.q || rawData.questions || []).map(item => ({
                        id: item.i || item.id, text: item.k || item.text, 
                        options: item.o || item.options, correct: item.c || item.correct, 
                        explanations: item.e || item.explanations
                    }))
                };
                setupExamUI();
                return;
            }

            // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
            showNoExamScreen();

        } catch(e) {
            console.error('Error:', e);
            alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ' + e.message);
            showNoExamScreen();
        }
    }

    // Ø¯Ø§Ù„Ø© ÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    // Ø¯Ø§Ù„Ø© ÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //           Ù†Ø¸Ø§Ù… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ (Ø¨Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // 1. Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: ØªÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± ÙˆØªØ¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… + ØªØ­ÙØ¸Ù‡Ø§ ÙÙŠ Firebase
    function loadAndSyncCategories() {
        const urlParams = new URLSearchParams(window.location.search);
        const catsData = urlParams.get('cats');
        
        if (catsData) {
            try {
                // ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
                const base64 = catsData.replace(/-/g, '+').replace(/_/g, '/');
                const binaryString = window.atob(base64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
                const decompressed = pako.inflate(bytes, { to: 'string' });
                const categories = JSON.parse(decompressed);
                
                // Ø£) Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                populateCategorySelect(categories);
                
                // Ø¨) ğŸ”¥ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase (Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„)
                if (typeof db !== 'undefined') {
                    db.collection('settings').doc('app_categories').set({
                        data: categories,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(() => console.log("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©"));
                }

                // Ø¬) ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                showScreen('adminPanel');

            } catch (e) {
                console.error(e);
                alert("Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + e.message);
            }
        }
    }

    // 2. Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: ØªØ¬Ù„Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ù† Firebase (Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠ)
    function fetchCategoriesFromCloud() {
        if (typeof db === 'undefined') return;
        
        console.log("â˜ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...");
        db.collection('settings').doc('app_categories').get().then((doc) => {
            if (doc.exists) {
                const categories = doc.data().data;
                console.log("ğŸ“¥ ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©");
                populateCategorySelect(categories);
            } else {
                console.log("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯ (ÙŠØ¬Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø§Ù„Ø¨ÙˆØª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)");
            }
        }).catch((err) => console.log("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:", err));
    }

    // 3. Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù…Ù„Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ù„Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„ÙƒÙˆØ¯)
    function populateCategorySelect(categories) {
        const select = document.getElementById('categorySelect');
        select.innerHTML = '<option value="" disabled selected>ğŸ”» Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>';
        
        categories.forEach(cat => {
            const group = document.createElement('optgroup');
            group.label = "ğŸ“‚ " + cat.n;
            if (cat.s && cat.s.length > 0) {
                cat.s.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub.i;
                    option.text = "ğŸ“„ " + sub.n;
                    group.appendChild(option);
                });
                select.appendChild(group);
            }
        });
    }


    // Ø¯Ø§Ù„Ø© ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø®Ø·Ø£ Ù‡Ù†Ø§)
    function setupExamUI() {
        if (!examData || examData.questions.length === 0) {
            showNoExamScreen();
            return;
        }
        
        // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        document.getElementById('loadingScreen').classList.add('hidden');

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        const examKey = `exam_${examData.id}_${examData.user_id}`;
        if (localStorage.getItem(examKey)) {
            const prevData = JSON.parse(localStorage.getItem(examKey));
            document.getElementById('prevScore').textContent = prevData.score + '%';
            showScreen('alreadyTakenScreen');
        } else {
            document.getElementById('examTitle').textContent = examData.title;
            document.getElementById('totalQuestions').textContent = examData.questions.length;
            document.getElementById('examDuration').textContent = examData.duration > 0 ? examData.duration + ' Ø¯Ù‚ÙŠÙ‚Ø©' : 'Ù…ÙØªÙˆØ­';
            showScreen('startScreen');
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //                    Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„ØªÙ†Ù‚Ù„
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function showScreen(screenId) {
        // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚
        document.querySelectorAll('.card, #examScreen').forEach(el => {
            el.classList.add('hidden');
        });
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        const targetScreen = document.getElementById(screenId);
        if (targetScreen) targetScreen.classList.remove('hidden');

        // ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø²Ø± Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø«Ù„Ø§Ø« ğŸ”¥
        const menuBtn = document.querySelector('.menu-btn');
        if (menuBtn) {
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‡ÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©ØŒ Ø£Ø¸Ù‡Ø± Ø§Ù„Ø²Ø±
            if (screenId === 'adminPanel') {
                menuBtn.style.display = 'block';
            } else {
                // ÙÙŠ Ø£ÙŠ Ø´Ø§Ø´Ø© Ø£Ø®Ø±Ù‰ (Ø§Ø®ØªØ¨Ø§Ø±ØŒ Ù†ØªÙŠØ¬Ø©ØŒ Ø§Ù„Ø®)ØŒ Ø§Ø®ÙÙ Ø§Ù„Ø²Ø±
                menuBtn.style.display = 'none';
                // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ùˆ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
                const menu = document.getElementById('dropdownMenu');
                if (menu) menu.classList.remove('show');
            }
        }
    }


    function showNoExamScreen() {
        showScreen('noExamScreen');
        
        // ğŸ”¥ Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø¨Ø§Ø± (Ø§Ù„Ø¥ØµÙ„Ø§Ø­)
        const container = document.getElementById('noExamScreen');
        if (!document.getElementById('statsCard')) {
            const card = document.createElement('div');
            card.id = 'statsCard';
            card.className = 'stats-card-btn'; // Ø³ÙŠØ£Ø®Ø° Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            card.innerHTML = `
                <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“ˆ</div>
                <h3 style="margin:0; font-size:24px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h3>
                <p style="margin:8px 0 0 0; opacity: 0.9; font-size:14px; line-height:1.5;">ØªØªØ¨Ø¹ Ù†Ø¬Ø§Ø­ÙƒØŒ Ø¯Ø±Ø¬Ø§ØªÙƒØŒ ÙˆÙ…Ø§ ÙØ§ØªÙƒ Ù…Ù† Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¨Ø¯Ù‚Ø© ÙˆÙ†Ø²Ø§Ù‡Ø©..</p>
            `;
            card.onclick = openMyStats;
            container.prepend(card); // ÙŠØ¶Ø¹Ù‡ ÙÙŠ Ø£ÙˆÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        }

        const user = window.Telegram.WebApp.initDataUnsafe?.user;
        if (user && OWNERS.includes(user.id)) {
            if (!document.getElementById('adminBtn')) {
                const btn = document.createElement('button');
                btn.id = 'adminBtn';
                btn.className = 'btn btn-success btn-block';
                btn.style.marginTop = '20px';
                btn.innerHTML = 'ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±)';
                btn.onclick = () => showScreen('adminPanel');
                container.appendChild(btn);
            }
        }
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //                    Ù…Ù†Ø·Ù‚ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function startExam() {
        showScreen('examScreen');
        startTime = new Date();
        userAnswers = [];
        currentQuestion = 0;

        if (examData.duration && examData.duration > 0) {
            timeRemaining = examData.duration * 60;
            startTimer();
        } else {
            document.getElementById('timerDisplay').textContent = 'â±ï¸ --:--';
        }
        displayQuestion(0);
    }

    function startTimer() {
        updateTimerDisplay();
        timerInterval = setInterval(() => {
            timeRemaining--;
            updateTimerDisplay();
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                finishExam(true);
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        const display = document.getElementById('timerDisplay');
        display.textContent = `â±ï¸ ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        if (timeRemaining <= 60) display.classList.add('danger');
    }

    function displayQuestion(index) {
        const question = examData.questions[index];
        currentQuestion = index;
        selectedOption = null;

        document.getElementById('questionBadge').textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}`;
        document.getElementById('questionText').textContent = question.text;
        document.getElementById('questionCounter').textContent = `${index + 1} / ${examData.questions.length}`;
        const progress = ((index + 1) / examData.questions.length) * 100;
        document.getElementById('progressBar').style.width = progress + '%';

        const container = document.getElementById('optionsContainer');
        container.innerHTML = '';
        const markers = ['Ø£', 'Ø¨', 'Ø¬', 'Ø¯', 'Ù‡Ù€', 'Ùˆ'];
        
        question.options.forEach((option, i) => {
            const optionEl = document.createElement('div');
            optionEl.className = 'option';
            optionEl.onclick = () => selectOption(i + 1, optionEl);
            optionEl.innerHTML = `<div class="option-marker">${markers[i] || (i + 1)}</div><div class="option-text">${option}</div>`;
            container.appendChild(optionEl);
        });

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = (index === examData.questions.length - 1) ? 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± âœ…' : 'Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸';
    }

    function selectOption(optionNum, element) {
        document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
        element.classList.add('selected');
        selectedOption = optionNum;
        document.getElementById('submitBtn').disabled = false;
    }

    function submitAnswer() {
        if (selectedOption === null) return;
        const question = examData.questions[currentQuestion];
        const isCorrect = selectedOption === question.correct;

        userAnswers.push({
            questionId: question.id,
            selected: selectedOption,
            correct: question.correct,
            isCorrect: isCorrect
        });

        const options = document.querySelectorAll('.option');
        options.forEach((opt, i) => {
            opt.classList.add('locked');
            if (i + 1 === question.correct) opt.classList.add('correct');
            else if (i + 1 === selectedOption && !isCorrect) opt.classList.add('wrong');
        });

        document.getElementById('submitBtn').disabled = true;

        if (!isCorrect && question.explanations && question.explanations[selectedOption]) {
            setTimeout(() => {
                document.getElementById('explanationText').textContent = question.explanations[selectedOption];
                document.getElementById('explanationModal').classList.remove('hidden');
            }, 600);
        } else {
            showToast(isCorrect ? 'âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!' : 'âŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©!', isCorrect);
            setTimeout(() => goToNextQuestion(), 1500);
        }
    }

    function closeExplanation() {
        document.getElementById('explanationModal').classList.add('hidden');
        goToNextQuestion();
    }

    function goToNextQuestion() {
        if (currentQuestion < examData.questions.length - 1) displayQuestion(currentQuestion + 1);
        else finishExam(false);
    }

    function showToast(message, success) {
        const toast = document.createElement('div');
        toast.className = `toast ${success ? 'success' : 'error'}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 1200);
    }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                    Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„Ø¨ÙˆØª

        function finishExam(timeout) {
            if (timerInterval) clearInterval(timerInterval);

            // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª
            const endTime = new Date();
            const timeTakenSeconds = Math.floor((endTime - startTime) / 1000);
            
            const totalQuestions = examData.questions.length;
            const correctCount = userAnswers.filter(a => a.isCorrect).length;
            const wrongCount = totalQuestions - correctCount;
            const scorePercent = Math.round((correctCount / totalQuestions) * 100);

            // 1. ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©
            let icon, title;
            if (scorePercent >= 90) { icon = 'ğŸ†'; title = 'Ù…Ù…ØªØ§Ø²!'; }
            else if (scorePercent >= 75) { icon = 'ğŸŒŸ'; title = 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹!'; }
            else if (scorePercent >= 50) { icon = 'âœ…'; title = 'Ù†Ø§Ø¬Ø­'; }
            else { icon = 'ğŸ“š'; title = 'Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'; }

            // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
            document.getElementById('resultIcon').textContent = icon;
            document.getElementById('resultTitle').textContent = title;
            document.getElementById('resultScore').textContent = scorePercent + '%';
            document.getElementById('statTotal').textContent = totalQuestions;
            document.getElementById('statCorrect').textContent = correctCount;
            document.getElementById('statWrong').textContent = wrongCount;
            
            const mins = Math.floor(timeTakenSeconds / 60);
            const secs = timeTakenSeconds % 60;
            document.getElementById('statTime').textContent = 
                `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;

            // 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„Ù‚Ù†Ø§Ø© ÙÙˆØ±Ø§Ù‹ (Ù„Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª)
            sendResultToChannel({
                exam_id: examData.id,
                exam_title: examData.title,
                user_id: examData.user_id,
                score: scorePercent,
                correct: correctCount,
                wrong: wrongCount,
                total: totalQuestions,
                time_taken: timeTakenSeconds,
                timeout: timeout,
                answers: userAnswers
            });

            // 4. ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù…ØªØºÙŠØ± (ÙÙŠ Ø­Ø§Ù„ Ù‚Ø±Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨ÙˆØª Ù„Ø§Ø­Ù‚Ø§Ù‹)
            finalResultToBot = {
                exam_id: examData.id,
                user_id: examData.user_id,
                score: scorePercent,
                correct: correctCount,
                wrong: wrongCount,
                total: totalQuestions,
                time_taken: timeTakenSeconds,
                answers: userAnswers
            };

            // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ Ù„Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†
            const examKey = `exam_${examData.id}_${examData.user_id}`;
            localStorage.setItem(examKey, JSON.stringify({
                score: scorePercent,
                correct: correctCount,
                wrong: wrongCount,
                time: timeTakenSeconds,
                date: new Date().toISOString()
            }));

            // 5. Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© (ÙˆØ§Ù„Ø¨Ù‚Ø§Ø¡ ÙÙŠÙ‡Ø§)
            showScreen('resultScreen');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                    Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù‚Ù†Ø§Ø©
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function sendResultToChannel(result) {
            const mins = Math.floor(result.time_taken / 60);
            const secs = result.time_taken % 60;
            
            let statusIcon;
            if (result.score >= 90) statusIcon = 'ğŸ†';
            else if (result.score >= 75) statusIcon = 'ğŸŒŸ';
            else if (result.score >= 50) statusIcon = 'âœ…';
            else statusIcon = 'âŒ';

            // Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ù†Ø§
            const message = `
ğŸ“Š Ù†ØªÙŠØ¬Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯Ø©
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${result.exam_title}
ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <a href="tg://user?id=${result.user_id}">${result.user_id}</a>

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ˆ Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${result.score}% ${statusIcon}
âœ… ØµØ­ÙŠØ­: ${result.correct}
âŒ Ø®Ø·Ø£: ${result.wrong}
ğŸ“‹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${result.total}

â± Ø§Ù„ÙˆÙ‚Øª: ${mins}:${String(secs).padStart(2, '0')}
${result.timeout ? 'âš ï¸ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!' : ''}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#Ù†ØªÙŠØ¬Ø©_Ø§Ø®ØªØ¨Ø§Ø± #exam_${result.exam_id}
`;

            const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… fetch Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø³Ø±Ø¹Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: CHANNEL_ID,
                    text: message,
                    parse_mode: 'HTML'
                })
            }).catch(e => console.log('Channel send error', e));
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                    Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                    Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                    Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ø¹Ø¯Ù„Ø©)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function closeApp() {
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ù…ØªØ§Ø­
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ù†ØªÙŠØ¬Ø©ØŒ Ø£Ø±Ø³Ù„Ù‡Ø§
                if (finalResultToBot) {
                    try {
                        // 1. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù†Øµ
                        let dataString = JSON.stringify(finalResultToBot);
                        
                        // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¬Ù… (ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… ÙŠÙ‚Ø¨Ù„ 4096 Ø¨Ø§ÙŠØª ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)
                        // Ù†Ø³ØªØ®Ø¯Ù… 4000 ÙƒØ­Ø¯ Ø¢Ù…Ù†
                        if (dataString.length > 4000) {
                            // Ø§Ù„Ø­Ø¬Ù… ÙƒØ¨ÙŠØ±! Ù†Ø­Ø°Ù ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ÙˆÙ†Ø±Ø³Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙ‚Ø·
                            const smallData = {
                                ...finalResultToBot,
                                answers: [] // Ø¥ÙØ±Ø§Øº Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù…
                            };
                            dataString = JSON.stringify(smallData);
                            // ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                            // alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø© ÙÙ‚Ø· Ù†Ø¸Ø±Ø§Ù‹ Ù„Ø·ÙˆÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±");
                        }

                        // 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¨ÙˆØª
                        tg.sendData(dataString);
                        
                    } catch (e) {
                        console.error("Error sending data:", e);
                        // ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ø£ÙŠ Ø³Ø¨Ø¨ØŒ Ù†ØºÙ„Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙˆØ±Ø§Ù‹
                        tg.close();
                    }
                } else {
                    // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ø§Ø¯ÙŠ (ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ÙŠØ¯Ø®Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø£Ùˆ Ø®Ø±Ø¬ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡)
                    tg.close();
                }
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø¯Ø§Ø®Ù„ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
                window.close();
                history.back();
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //               Ù…Ù†Ø·Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø£Ø¯Ù…Ù†)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let qCounter = 0;

        // 1. Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„ÙˆÙ‚Øª
        function toggleDurationInput() {
            const isChecked = document.getElementById('timerToggle').checked;
            const field = document.getElementById('durationInputContainer');
            if (isChecked) field.classList.add('active');
            else field.classList.remove('active');
        }

        // 2. Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ„
        // 1. Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ„ (Ù…Ø­Ø¯Ø«Ø©)
        function toggleExplanationFields() {
            const isChecked = document.getElementById('explanationToggle').checked;
            const allExpls = document.querySelectorAll('.opt-expl');
            
            allExpls.forEach(input => {
                if (!isChecked) {
                    input.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙ„ ÙÙˆØ±Ø§Ù‹
                } else {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø²Ø± Ù…ÙØ¹Ù„ØŒ Ù†Ø¸Ù‡Ø± ÙÙ‚Ø· Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙŠ Ù„ÙŠØ³Øª Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
                    const row = input.closest('.option-row');
                    const isCorrect = row.querySelector('input[type="radio"]').checked;
                    input.style.display = isCorrect ? 'none' : 'block';
                }
            });
        }


        // 3. Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø¨Ø·Ø§Ù‚Ø© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯Ø©
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //           Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³Ø¤Ø§Ù„
        function addQuestionCard() {
            qCounter++;
            const container = document.getElementById('questionsContainer');
            const card = document.createElement('div');
            card.className = 'edit-card';
            card.id = `card_${qCounter}`; // Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø©
            
            // Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ø³Ø¤Ø§Ù„ (Ø¨Ø¯ÙˆÙ† Ø®ÙŠØ§Ø±Ø§Øª Ø«Ø§Ø¨ØªØ©)
            card.innerHTML = `
                <button class="remove-q-btn" onclick="this.parentElement.remove()">Ã—</button>
                <label class="input-label">Ø§Ù„Ø³Ø¤Ø§Ù„ ${qCounter}:</label>
                <textarea class="form-input q-text" rows="2" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§..."></textarea>
                
                <div class="options-wrapper" id="options_wrapper_${qCounter}"></div>

                <button class="btn btn-outline" style="margin-top:10px; font-size:12px; padding:8px 15px; width:auto; border-style:dashed;" onclick="addOption(${qCounter})">
                    â• Ø¥Ø¶Ø§ÙØ© Ø§Ø®ØªÙŠØ§Ø±
                </button>
            `;
            container.appendChild(card);
            
            // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±ÙŠÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠÙŠÙ† Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ø¤Ø§Ù„
            addOption(qCounter);
            addOption(qCounter);
            
            // ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ù„Ø£Ø³ÙÙ„
            setTimeout(() => {
                 card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± Ø®ÙŠØ§Ø± Ø¬Ø¯ÙŠØ¯
        // 1. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± (ØªØ±Ø§Ù‚Ø¨ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ¹Ù„ÙŠÙ„)
        function addOption(cardId) {
            const wrapper = document.getElementById(`options_wrapper_${cardId}`);
            if (!wrapper) return;
            const optCount = wrapper.children.length + 1;
            
            const div = document.createElement('div');
            div.className = 'option-row';
            div.style.cssText = "background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #eee; position: relative;";
            
            div.innerHTML = `
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:5px;">
                    <input type="radio" name="rad_${cardId}" value="${optCount}" 
                           onchange="syncExplVisibility(${cardId})" 
                           style="transform:scale(1.2); cursor:pointer;">
                    
                    <input type="text" class="admin-input opt-text" placeholder="Ù†Øµ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±" style="flex:1; margin:0;">
                    
                    <button onclick="removeOption(this)" style="background:none; border:none; color:red; cursor:pointer; font-size:20px; padding:0 5px;">Ã—</button>
                </div>
                
                <input type="text" class="admin-input opt-expl" placeholder="ğŸ’¡ ØªØ¹Ù„ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ (ÙŠØ¸Ù‡Ø± Ù„Ù„Ø·Ø§Ù„Ø¨ Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¬ÙˆØ§Ø¨)" 
                       style="font-size:12px; background:white; margin-top:5px; margin-bottom:0; display:none;">
            `;
            wrapper.appendChild(div);
            
            updateOptionValues(cardId);
            syncExplVisibility(cardId); // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­Ø§Ù„Ø© ÙÙˆØ± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        }

        // 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ØªØªØ­ÙƒÙ… ÙÙŠ Ø¸Ù‡ÙˆØ± Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ (Ø§Ù„Ø²Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ + Ù‡Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©)
        function syncExplVisibility(cardId) {
            const isToggleOn = document.getElementById('explanationToggle').checked;
            const wrapper = document.getElementById(`options_wrapper_${cardId}`);
            if (!wrapper) return;

            const rows = wrapper.querySelectorAll('.option-row');
            rows.forEach(row => {
                const radio = row.querySelector('input[type="radio"]');
                const explInput = row.querySelector('.opt-expl');
                
                if (!isToggleOn) {
                    explInput.style.display = 'none'; // Ù…Ø®ÙÙŠ Ù„Ø£Ù† Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ù… Ù…ØºÙ„Ù‚
                } else {
                    // ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ùˆ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø± ÙƒØµØ­ÙŠØ­
                    explInput.style.display = radio.checked ? 'none' : 'block';
                }
            });
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø­Ø°Ù Ø®ÙŠØ§Ø±
        function removeOption(btn) {
            const row = btn.closest('.option-row');
            const wrapper = row.parentElement;
            
            // Ù…Ù†Ø¹ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (ÙŠØ¬Ø¨ Ø¨Ù‚Ø§Ø¡ Ø®ÙŠØ§Ø±ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)
            if (wrapper.children.length <= 2) {
                alert("âš ï¸ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø®ÙŠØ§Ø±Ø§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!");
                return;
            }
            
            const wrapperId = wrapper.id.split('_')[2]; // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù… Ø§Ù„Ø³Ø¤Ø§Ù„
            row.remove();
            updateOptionValues(wrapperId);
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
        // Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ÙˆÙ…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ„Ø§Øª
        function updateOptionValues(cardId) {
            const wrapper = document.getElementById(`options_wrapper_${cardId}`);
            if (!wrapper) return;
            
            const rows = wrapper.querySelectorAll('.option-row');
            
            rows.forEach((row, index) => {
                const radio = row.querySelector('input[type="radio"]');
                // ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±Ø§Ø¯ÙŠÙˆ Ù„ØªØ¸Ù„ Ù…Ø±ØªØ¨Ø© 1, 2, 3...
                radio.value = index + 1; 
            });

            // ğŸ”¥ Ø£Ù‡Ù… Ø³Ø·Ø±: Ù…Ø²Ø§Ù…Ù†Ø© Ø¸Ù‡ÙˆØ± Ø§Ù„ØªØ¹Ù„ÙŠÙ„Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            if (typeof syncExplVisibility === 'function') {
                syncExplVisibility(cardId);
            }
        }



        // 4. Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„Ø¨ÙˆØª (Ù†Ø³Ø®Ø© Ø§Ù„ØªØµØ­ÙŠØ­)
    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© (Ù„ØªÙ‚Ø±Ø£ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ)
    async function saveExamToCloud() {
        const title = document.getElementById('examTitleInput').value;
        const subId = document.getElementById('categorySelect').value;
        
        if (!title || !subId) {
            alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù…!");
            return;
        }

        const cards = document.querySelectorAll('.edit-card');
        if (cards.length === 0) return alert("âš ï¸ Ø£Ø¶Ù Ø³Ø¤Ø§Ù„Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");

        // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        document.getElementById('loadingScreen').classList.remove('hidden');
        
        try {
            const questions = [];
            
            // Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø¹Ù„Ù‰ ÙƒÙ„ Ø¨Ø·Ø§Ù‚Ø© Ø³Ø¤Ø§Ù„
            for (let i = 0; i < cards.length; i++) {
                const card = cards[i];
                const text = card.querySelector('.q-text').value.trim();
                
                if (!text) throw new Error(`Ø§Ù„Ø³Ø¤Ø§Ù„ Ø±Ù‚Ù… ${i+1} ÙØ§Ø±Øº!`);

                // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ ØµÙÙˆÙ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø¯Ø§Ø®Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„
                const rows = card.querySelectorAll('.option-row');
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©
                const selectedRadio = card.querySelector('input[type="radio"]:checked');
                if (!selectedRadio) {
                    throw new Error(`Ø§Ù„Ø³Ø¤Ø§Ù„ Ø±Ù‚Ù… ${i+1}: Ù„Ù… ØªØ­Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©!`);
                }
                
                // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© (1, 2, 3...)
                const correctIndex = parseInt(selectedRadio.value); 

                const optionsList = [];
                const explanationsMap = {};

                // Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø¹Ù„Ù‰ ÙƒÙ„ Ø®ÙŠØ§Ø± Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ„
                rows.forEach((row, idx) => {
                    const optText = row.querySelector('.opt-text').value.trim();
                    const optExpl = row.querySelector('.opt-expl').value.trim();
                    const currentIdx = idx + 1; // Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ (1-based)

                    if (!optText) throw new Error(`ÙŠÙˆØ¬Ø¯ Ø®ÙŠØ§Ø± ÙØ§Ø±Øº ÙÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø±Ù‚Ù… ${i+1}`);
                    
                    optionsList.push(optText);
                    
                    // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ù„ÙŠÙ„ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®ÙŠØ§Ø± "Ø®Ø·Ø£" ÙˆØªÙ…Øª ÙƒØªØ§Ø¨Ø© ØªØ¹Ù„ÙŠÙ„ Ù„Ù‡
                    // (Ù„Ø§ Ù†Ø­ÙØ¸ ØªØ¹Ù„ÙŠÙ„ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„Ø£Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ø§ ÙŠØ­ØªØ§Ø¬Ù‡)
                    if (currentIdx !== correctIndex && optExpl) {
                        explanationsMap[currentIdx] = optExpl;
                    }
                });

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
                questions.push({
                    text: text,
                    options: optionsList,
                    correct: correctIndex,
                    explanations: explanationsMap
                });
            }

            // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©
            const durationToggle = document.getElementById('timerToggle');
            const durationVal = (durationToggle && durationToggle.checked) 
                                ? (parseInt(document.getElementById('examDurationInput').value) || 0) 
                                : 0;

            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Firebase
            const docRef = await db.collection("exams").add({
                title: title,
                duration: durationVal,
                questions: questions,
                created_at: firebase.firestore.FieldValue.serverTimestamp()
            });

            // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¥Ø¹Ø§Ø¯ØªÙ‡Ø§ Ù„Ù„Ø¨ÙˆØª
            const dataToSend = JSON.stringify({
                type: "cloud_exam",
                exam_id: docRef.id,
                title: title,
                target_sub_id: subId
            });

            // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¨ÙˆØª
            if (window.Telegram && window.Telegram.WebApp) {
                alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆÙ†Ø´Ø±Ù‡ Ø¨Ù†Ø¬Ø§Ø­!");
                window.Telegram.WebApp.sendData(dataToSend);
            } else {
                alert('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ (ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©)! ID: ' + docRef.id);
                document.getElementById('loadingScreen').classList.add('hidden');
            }

        } catch (e) {
            console.error(e);
            alert("âŒ Ø®Ø·Ø£: " + e.message);
            document.getElementById('loadingScreen').classList.add('hidden');
        }
    }


    // â•â•â•â•â•â•â•â•â•â•â•â• Ø¯ÙˆØ§Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„Ø®Ø·ÙˆØ· â•â•â•â•â•â•â•â•â•â•â•â•
    
    function toggleMenu() {
        const menu = document.getElementById('dropdownMenu');
        menu.classList.toggle('show');
    }

    // Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ¥Ø®ÙØ§Ø¡ ÙÙˆØ±Ù… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    function toggleCreateForm() {
        const form = document.getElementById('createExamForm');
        form.style.display = (form.style.display === 'block') ? 'none' : 'block';
    }

    // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù
    function triggerFontUpload() {
        document.getElementById('fontFileInput').click();
        toggleMenu(); 
    }

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„Ø®Ø· ÙˆØªØ·Ø¨ÙŠÙ‚Ù‡
    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„Ø®Ø· ÙˆØ­ÙØ¸Ù‡ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¬Ù…ÙŠØ¹
    function handleFontUpload(input) {
        const file = input.files[0];
        if (!file) return;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¬Ù… (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 800 ÙƒÙŠÙ„ÙˆØ¨Ø§ÙŠØª Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
        if (file.size > 800 * 1024) {
            alert("âš ï¸ Ù…Ù„Ù Ø§Ù„Ø®Ø· ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹! (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 800kb)\nØ­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù„Ù Ø¨ØµÙŠØºØ© WOFF2 ÙÙ‡ÙŠ Ø£Ø®Ù.");
            return;
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ø£Ù† Ø§Ù„Ø±ÙØ¹ Ù‚Ø¯ ÙŠØ£Ø®Ø° Ø«ÙˆØ§Ù†ÙŠ
        document.getElementById('loadingScreen').classList.remove('hidden');

        const reader = new FileReader();
        reader.onload = function(e) {
            const fontData = e.target.result;
            
            // Ø­ÙØ¸ Ø§Ù„Ø®Ø· ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Firestore) Ù„ÙŠØ±Ø§Ù‡ Ø§Ù„Ø¬Ù…ÙŠØ¹
            db.collection('settings').doc('global_config').set({
                customFont: fontData,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true })
            .then(() => {
                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø· ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯Ùƒ
                applyCustomFont(fontData);
                document.getElementById('loadingScreen').classList.add('hidden');
                alert("âœ… ØªÙ… ØªØ¹Ù…ÙŠÙ… Ø§Ù„Ø®Ø· Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­!");
            })
            .catch((error) => {
                console.error("Error saving font: ", error);
                document.getElementById('loadingScreen').classList.add('hidden');
                alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ø®Ø·: " + error.message);
            });
        };
        reader.readAsDataURL(file);
    }


    // Ø¯Ø§Ù„Ø© Ø­Ù‚Ù† Ø§Ù„Ø®Ø· ÙÙŠ Ø§Ù„ØµÙØ­Ø©
    function applyCustomFont(base64Data) {
        // Ø­Ø°Ù Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù† ÙˆØ¬Ø¯
        const oldStyle = document.getElementById('custom-font-style');
        if (oldStyle) oldStyle.remove();

        const style = document.createElement('style');
        style.id = 'custom-font-style';
        style.textContent = `
            @font-face { font-family: 'UserFont'; src: url('${base64Data}'); }
            body, button, input, select, textarea, .app-title {
                font-family: 'UserFont', sans-serif !important;
            }
        `;
        document.head.appendChild(style);
    }

    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø®Ø· Ø§Ù„Ø£ØµÙ„ÙŠ
    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø®Ø· Ø§Ù„Ø£ØµÙ„ÙŠ ÙˆØ­Ø°ÙÙ‡ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    function resetFont() {
        if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØ¹ÙˆØ¯ Ø§Ù„Ø®Ø· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.")) return;
        
        document.getElementById('loadingScreen').classList.remove('hidden');
        
        // Ø­Ø°Ù Ø§Ù„Ø­Ù‚Ù„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        db.collection('settings').doc('global_config').update({
            customFont: firebase.firestore.FieldValue.delete()
        }).then(() => {
            const oldStyle = document.getElementById('custom-font-style');
            if (oldStyle) oldStyle.remove();
            toggleMenu();
            document.getElementById('loadingScreen').classList.add('hidden');
            alert("ğŸ”„ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø®Ø· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹.");
        }).catch((error) => {
            alert("Ø®Ø·Ø£: " + error.message);
            document.getElementById('loadingScreen').classList.add('hidden');
        });
    }


    function toggleNightMode() {
        document.body.classList.toggle('night-mode');
        const isNight = document.body.classList.contains('night-mode');
        document.getElementById('themeBtn').textContent = isNight ? 'â˜€ï¸' : 'ğŸŒ™';
        localStorage.setItem('nightMode', isNight);
    }

    async function openMyStats() {
        showScreen('statsScreen');
        let taken = 0, totalScore = 0, takenIds = [];
        for (let i = 0; i < localStorage.length; i++) {
            let key = localStorage.key(i);
            if (key && key.startsWith('exam_')) {
                taken++;
                try {
                    let d = JSON.parse(localStorage.getItem(key));
                    totalScore += parseFloat(d.score || 0);
                    takenIds.push(key.split('_')[1]);
                } catch(e) {}
            }
        }
        document.getElementById('stTaken').textContent = taken;
        document.getElementById('stAvg').textContent = taken > 0 ? Math.round(totalScore/taken) + "%" : "0%";
        
        try {
            const snap = await db.collection("exams").get();
            let pending = 0;
            snap.forEach(doc => { if(!takenIds.includes(doc.id)) pending++; });
            document.getElementById('stPending').textContent = pending;
        } catch(e) {}
    }
    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙØ¶Ù„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    if(localStorage.getItem('nightMode') === 'true') {
        document.body.classList.add('night-mode');
        document.getElementById('themeBtn').textContent = 'â˜€ï¸';
    }


    </script>
</body>
</html>
